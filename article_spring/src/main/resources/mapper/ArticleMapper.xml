<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.koo.article_spring.repository.mybatis.ArticleMapper">
    <select id="getArticleTotalCount" parameterType="Pagination" resultType="Integer">
        SELECT COUNT(*)
        FROM articles
        WHERE 1=1
        <if test="categoryId != null">
            AND category_id = #{categoryId}
        </if>
        <if test="searchTerm != null and !''.equals(searchTerm) ">
            AND (author LIKE CONCAT('%', #{searchTerm}, '%') OR title LIKE CONCAT('%', #{searchTerm}, '%') OR contents
            LIKE CONCAT('%', #{searchTerm}, '%'))
        </if>
        <if test="startDate != null and endDate != null">
            AND create_time BETWEEN #{startDate} AND #{endDate}
        </if>
    </select>

    <select id="getArticleList" parameterType="Pagination" resultType="ArticleDTO">
        SELECT
        title,
        contents,
        author,
        views,
        create_time,
        modified_time,
        category_id,
        article_id
        FROM articles
        WHERE 1=1
        <if test="categoryId != null">
            AND category_id = #{categoryId}
        </if>
        <if test="searchTerm != null and !''.equals(searchTerm) ">
            AND (author LIKE CONCAT('%', #{searchTerm}, '%') OR title LIKE CONCAT('%', #{searchTerm}, '%') OR contents
            LIKE CONCAT('%', #{searchTerm}, '%'))
        </if>
        <if test="startDate != null and endDate != null">
            AND create_time BETWEEN #{startDate} AND #{endDate}
        </if>
        ORDER BY article_id DESC
        LIMIT #{start}, #{recordsPerPage}
    </select>

    <select id="getArticle" parameterType="Integer" resultType="ArticleDTO">
        SELECT
            author,
            title,
            views,
            contents,
            create_time,
            category_id,
            modified_time,
            article_id
        FROM articles
        WHERE article_id = #{articleId}
    </select>

    <insert id="insertArticle" parameterType="ArticleDTO" useGeneratedKeys="true" keyProperty="articleId">
        INSERT INTO articles (category_id, author, password, title, contents, create_time, modified_time)
        VALUES (#{categoryId}, #{author}, #{password}, #{title}, #{contents}, #{createTime}, #{modifiedTime})
    </insert>

    <update id="updateViews" parameterType="ArticleDTO">
        UPDATE articles
        SET views = #{views}
        WHERE article_id = #{articleId}
    </update>
</mapper>

